include:
    - path: ../ddns/docker-compose.yml
      env_file: ../ddns/.env

name: gateway
services:
  pocketid:
    image: ghcr.io/pocket-id/pocket-id:v1
    container_name: pocketid
    depends_on:
      - traefik
    restart: unless-stopped
    networks:
      - mynetwork
    environment:
      - TRUST_PROXY=true
      - APP_URL=https://auth.${DOMAIN}
      - INTERNAL_APP_URL=http://pocketid:1411
    volumes:
      - pocketid-data:/app/data
    healthcheck:
      test: [CMD, /app/pocket-id, healthcheck]
      interval: 15s
      retries: 10
      start_period: 10s
    labels:
      - traefik.enable=true
      - traefik.http.routers.pocketid.tls=true
      - traefik.http.routers.pocketid.tls.certresolver=le
      - traefik.http.routers.pocketid.rule=Host(`auth.${DOMAIN}`)
      - traefik.http.routers.pocketid.tls.domains[0].main=auth.${DOMAIN}
      - traefik.http.services.pocketid.loadbalancer.server.port=1411

    dns:
        image: dockurr/dnsmasq:latest
        ports:
            - "53:53/udp" #DNS service
            - "53:53/tcp" #DNS service
        cap_add:
            - NET_ADMIN
        volumes:
            - ./dnsmasq.conf:/etc/dnsmasq.conf
        sysctls:
            - net.ipv4.ip_local_port_range=1024 65000
        healthcheck:
            test:
                [
                    "CMD",
                    "dig",
                    "+time=2",
                    "+tries=1",
                    "@127.0.0.1",
                    "google.com",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        restart: always
  traefik:
    image: traefik:v3
    container_name: gateway_traefik
    env_file:
      - .env
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      - --accesslog=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=mynetwork
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.email=${LE_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpChallenge.entrypoint=web
      - --certificatesresolvers.le.acme.httpChallenge=true
      - "--certificatesresolvers.le.acme.preferredChain=ISRG Root X1"
      - --experimental.plugins.traefik-oidc-auth.moduleName=github.com/sevensolutions/traefik-oidc-auth
      - --experimental.plugins.traefik-oidc-auth.version=v0.17.0
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)
      - traefik.http.routers.traefik.tls=true
      - traefik.http.routers.traefik.tls.certresolver=le
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.services.api.loadbalancer.server.port=8080
      - traefik.http.routers.traefik.tls.domains[0].main=traefik.${DOMAIN}
      - traefik.http.routers.traefik.middlewares=oidc-auth@file
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-le:/letsencrypt
      - ./config/traefik:/etc/traefik/dynamic:ro
    networks:
      - mynetwork

  homarr:
    container_name: homarr
    image: ghcr.io/homarr-labs/homarr:latest
    restart: unless-stopped
    networks:
      - mynetwork
    environment:
      - PUID=1000
      - PGID=121
      - TZ=Europe/Amsterdam
      - SECRET_ENCRYPTION_KEY=${HOMARR_SECRET_KEY}
      # OIDC Configuration
      - BASE_URL=https://home.${DOMAIN}
      - NEXTAUTH_URL=https://home.${DOMAIN}
      - AUTH_PROVIDERS=oidc,credentials
      - AUTH_OIDC_CLIENT_NAME=PocketID
      - AUTH_OIDC_ISSUER=https://auth.${DOMAIN}
      - AUTH_OIDC_CLIENT_ID=${HOMARR_OIDC_CLIENT_ID}
      - AUTH_OIDC_CLIENT_SECRET=${HOMARR_OIDC_CLIENT_SECRET}
      - AUTH_OIDC_SCOPE_OVERWRITE=openid email profile groups
      - AUTH_OIDC_GROUPS_ATTRIBUTE=groups
      - AUTH_LOGOUT_REDIRECT_URL=https://auth.${DOMAIN}
    volumes:
      - homarr-config:/appdata
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.homarr.tls=true
      - traefik.http.routers.homarr.tls.certresolver=le
      - traefik.http.routers.homarr.tls.domains[0].main=home.${DOMAIN}
      - traefik.http.routers.homarr.rule=Host(`home.${DOMAIN}`)
      - traefik.http.routers.homarr.service=homarr
      - traefik.http.services.homarr.loadbalancer.server.port=7575
      - traefik.http.routers.homarr.middlewares=oidc-auth@file

networks:
  mynetwork:
    external: true

volumes:
  traefik-le:
  homarr-config:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/home/8tomat8/home-gateway/config/homarr"
  pocketid-data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/home/8tomat8/home-gateway/config/pocketid"
